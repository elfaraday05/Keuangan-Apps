<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack - Pencatat Keuangan</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 via-blue-50 to-indigo-100 min-h-screen text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Ikon SVG Sederhana (Custom)
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>,
            RefreshCw: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            ArrowUpRight: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M7 7h10v10"/><path d="M7 17 17 7"/></svg>,
            ArrowDownRight: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m7 7 10 10"/><path d="M17 7v10H7"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            PieChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        };

        const API_URL = "https://script.google.com/macros/s/AKfycbzH_cIqnzoPGz-j82iVxknDcrPYzhH9KWyIHAUVjx38E9pQgInqHaVeUQnqQtEHhc0/exec";

        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        const TransactionItem = ({ item }) => {
            const isExpense = item.type === 'expense';
            const displayNote = item.description || item.note || "Tanpa Keterangan";
            
            return (
                <div className="flex items-center justify-between p-4 hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">
                    <div className="flex items-center gap-4">
                        <div className={`p-2.5 rounded-full ${isExpense ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-500'}`}>
                            {isExpense ? <Icons.ArrowDownRight /> : <Icons.ArrowUpRight />}
                        </div>
                        <div>
                            <p className="font-semibold text-slate-700">{displayNote}</p>
                            <div className="flex items-center gap-2 text-xs text-slate-400 mt-0.5">
                                <span>{new Date(item.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                            </div>
                        </div>
                    </div>
                    <span className={`font-bold ${isExpense ? 'text-rose-500' : 'text-emerald-500'}`}>
                        {isExpense ? '-' : '+'} {formatRupiah(item.amount)}
                    </span>
                </div>
            );
        };

        const ExpenseChart = ({ data }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || data.length === 0) return;

                // Proses data untuk grafik (Top 5 Pengeluaran)
                const expenses = data.filter(t => t.type === 'expense');
                const grouped = expenses.reduce((acc, curr) => {
                    const desc = curr.description || "Lainnya";
                    acc[desc] = (acc[desc] || 0) + Number(curr.amount);
                    return acc;
                }, {});

                const labels = Object.keys(grouped).sort((a, b) => grouped[b] - grouped[a]).slice(0, 5);
                const values = labels.map(l => grouped[l]);

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
                        },
                        cutout: '65%'
                    }
                });

                return () => {
                    if (chartRef.current) chartRef.current.destroy();
                };
            }, [data]);

            return (
                <div className="p-4 bg-white rounded-3xl border border-slate-100 shadow-sm mb-6 animate-fade-in-up">
                    <h2 className="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider flex items-center gap-2">
                        <Icons.PieChart /> Alokasi Pengeluaran
                    </h2>
                    <div className="relative h-64 flex justify-center">
                        {data.filter(t => t.type === 'expense').length > 0 ? (
                            <canvas ref={canvasRef}></canvas>
                        ) : (
                            <div className="flex items-center justify-center text-slate-300 italic text-sm text-center">
                                Belum ada data pengeluaran untuk periode ini
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);
            const [activeTab, setActiveTab] = useState('add');

            // State Filter
            const [filterStart, setFilterStart] = useState('');
            const [filterEnd, setFilterEnd] = useState('');

            const [formData, setFormData] = useState({
                type: 'expense',
                amount: '',
                category: 'Umum', 
                description: '',
                date: new Date().toISOString().split('T')[0]
            });

            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}?action=read`);
                    const result = await response.json();
                    if (result.status === 'success') {
                        setTransactions(result.data);
                    }
                } catch (error) {
                    console.error("Gagal sinkronisasi data:", error);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitting(true);
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'add', ...formData })
                    });
                    
                    setTransactions([{ ...formData, timestamp: new Date() }, ...transactions]);
                    setFormData({ ...formData, amount: '', description: '' });
                    setActiveTab('list');
                } catch (error) {
                    console.error("Gagal menyimpan ke server:", error);
                    alert("Koneksi bermasalah. Data gagal disimpan.");
                } finally {
                    setSubmitting(false);
                }
            };

            // Logika Filtering
            const filteredData = useMemo(() => {
                return transactions.filter(t => {
                    const tDate = new Date(t.date).getTime();
                    const start = filterStart ? new Date(filterStart).getTime() : 0;
                    const end = filterEnd ? new Date(filterEnd).getTime() : Infinity;
                    // Reset jam ke 00:00 untuk perbandingan tanggal yang akurat
                    return tDate >= start && tDate <= end;
                });
            }, [transactions, filterStart, filterEnd]);

            const summary = useMemo(() => {
                const income = filteredData.filter(t => t.type === 'income').reduce((a, b) => a + Number(b.amount), 0);
                const expense = filteredData.filter(t => t.type === 'expense').reduce((a, b) => a + Number(b.amount), 0);
                return { income, expense, balance: income - expense };
            }, [filteredData]);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl overflow-hidden relative">
                    {/* Header Area */}
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-500 p-8 pb-24 rounded-b-[2.5rem] shadow-lg">
                        <div className="flex justify-between items-center text-white mb-6">
                            <div>
                                <p className="text-blue-100 text-sm">Saldo Periode Ini</p>
                                <h1 className="text-3xl font-bold">{formatRupiah(summary.balance)}</h1>
                            </div>
                            <button onClick={fetchData} className="bg-white/20 hover:bg-white/30 p-2 rounded-full backdrop-blur-sm transition">
                                <Icons.RefreshCw className={loading ? "animate-spin" : ""} />
                            </button>
                        </div>
                    </div>

                    {/* Content Area */}
                    <div className="px-5 -mt-16 relative z-20 pb-20">
                        
                        {/* Summary Cards */}
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-2xl shadow-md border border-emerald-100 flex flex-col items-center">
                                <Icons.ArrowUpRight className="text-emerald-500 mb-1" />
                                <p className="text-xs text-slate-400 font-medium">Pemasukan</p>
                                <p className="text-emerald-600 font-bold">{formatRupiah(summary.income)}</p>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-md border border-rose-100 flex flex-col items-center">
                                <Icons.ArrowDownRight className="text-rose-500 mb-1" />
                                <p className="text-xs text-slate-400 font-medium">Pengeluaran</p>
                                <p className="text-rose-600 font-bold">{formatRupiah(summary.expense)}</p>
                            </div>
                        </div>

                        {/* Date Filters Area */}
                        <div className="bg-white/80 backdrop-blur-md p-4 rounded-2xl border border-blue-50 shadow-sm mb-6 flex items-center gap-3">
                            <div className="flex-1">
                                <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-tighter">Dari</label>
                                <input 
                                    type="date" 
                                    value={filterStart} 
                                    onChange={(e) => setFilterStart(e.target.value)}
                                    className="w-full text-xs p-1.5 border-none bg-slate-50 rounded-lg outline-none focus:ring-1 focus:ring-blue-200" 
                                />
                            </div>
                            <div className="flex-1">
                                <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-tighter">Sampai</label>
                                <input 
                                    type="date" 
                                    value={filterEnd} 
                                    onChange={(e) => setFilterEnd(e.target.value)}
                                    className="w-full text-xs p-1.5 border-none bg-slate-50 rounded-lg outline-none focus:ring-1 focus:ring-blue-200" 
                                />
                            </div>
                            <button 
                                onClick={() => {setFilterStart(''); setFilterEnd('')}}
                                className="mt-4 p-2 text-slate-300 hover:text-rose-400 transition"
                                title="Reset Filter"
                            >
                                <Icons.Plus /> 
                            </button>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-6">
                            <button onClick={() => setActiveTab('add')} className={`flex-1 py-2 text-xs font-bold rounded-xl transition ${activeTab === 'add' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}>INPUT</button>
                            <button onClick={() => setActiveTab('list')} className={`flex-1 py-2 text-xs font-bold rounded-xl transition ${activeTab === 'list' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}>RIWAYAT</button>
                            <button onClick={() => setActiveTab('chart')} className={`flex-1 py-2 text-xs font-bold rounded-xl transition ${activeTab === 'chart' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}>ANALITIK</button>
                        </div>

                        {/* CONTENT: INPUT */}
                        {activeTab === 'add' && (
                            <form onSubmit={handleSubmit} className="space-y-4 animate-fade-in-up">
                                <div className="grid grid-cols-2 gap-3">
                                    <div onClick={() => setFormData({...formData, type: 'income'})} className={`cursor-pointer border-2 rounded-xl p-3 text-center font-bold transition-all ${formData.type === 'income' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-transparent bg-slate-50 text-slate-400'}`}>Pemasukan</div>
                                    <div onClick={() => setFormData({...formData, type: 'expense'})} className={`cursor-pointer border-2 rounded-xl p-3 text-center font-bold transition-all ${formData.type === 'expense' ? 'border-rose-500 bg-rose-50 text-rose-700' : 'border-transparent bg-slate-50 text-slate-400'}`}>Pengeluaran</div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 ml-1 mb-1 block uppercase">Jumlah (Rp)</label>
                                    <input type="number" required value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none transition" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 ml-1 mb-1 block uppercase">Keterangan</label>
                                    <input type="text" required value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none transition" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 ml-1 mb-1 block uppercase">Tanggal</label>
                                    <input type="date" required value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none transition" />
                                </div>
                                <button type="submit" disabled={submitting} className="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-blue-700 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-4 disabled:opacity-70">
                                    {submitting ? <div className="loader"></div> : <><Icons.Save /> Simpan ke Cloud</>}
                                </button>
                            </form>
                        )}

                        {/* CONTENT: RIWAYAT */}
                        {activeTab === 'list' && (
                            <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden min-h-[400px] animate-fade-in-up">
                                {loading ? (
                                    <div className="flex flex-col justify-center items-center h-64 gap-3"><div className="loader"></div></div>
                                ) : filteredData.length === 0 ? (
                                    <div className="text-center p-16"><p className="text-slate-400 italic">Data tidak ditemukan.</p></div>
                                ) : (
                                    <div className="divide-y divide-slate-50">
                                        {filteredData.map((t, i) => <TransactionItem key={i} item={t} />)}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* CONTENT: ANALITIK */}
                        {activeTab === 'chart' && (
                            <div className="space-y-6 animate-fade-in-up">
                                <ExpenseChart data={filteredData} />
                                <div className="p-5 bg-white rounded-3xl border border-slate-100 shadow-sm">
                                    <h2 className="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider">Statistik Periode</h2>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-400">Rata-rata Harian</span>
                                            <span className="font-bold">{formatRupiah(summary.expense / (filteredData.length || 1))}</span>
                                        </div>
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-400">Total Transaksi</span>
                                            <span className="font-bold">{filteredData.length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
